
<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALIBRATION TFS TOOLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', 'Noto Sans Thai', sans-serif; }
        :root { --schindler-red: #d52b1e; }
        body { background-color: #f8fafc; }

        /* --- Dashboard UI --- */
        .box-3d {
            background-color: white; border: 1px solid #e5e7eb;
            box-shadow: 4px 4px 0px 0px rgba(0, 0, 0, 0.08); 
            transition: all 0.2s ease; cursor: pointer;
        }
        
        /* Active Filter forced white text for readability */
        .card-active-all, .card-active-normal, .card-active-warning, .card-active-overdue {
            color: white !important; transform: translate(2px, 2px); box-shadow: 0px 0px 0px 0px transparent !important;
        }
        .card-active-all { background-color: #334155 !important; border-color: #1e293b !important; }
        .card-active-normal { background-color: #059669 !important; border-color: #064e3b !important; }
        .card-active-warning { background-color: #d97706 !important; border-color: #92400e !important; }
        .card-active-overdue { background-color: #d52b1e !important; border-color: #991b1b !important; }

        .card-active-all p, .card-active-all h3, .card-active-normal p, .card-active-normal h3,
        .card-active-warning p, .card-active-warning h3, .card-active-overdue p, .card-active-overdue h3 {
            color: white !important; opacity: 1 !important;
        }

        .tool-card { border-top: 4px solid transparent; }
        .border-normal { border-top-color: #10b981; }
        .border-warning { border-top-color: #f59e0b; }
        .border-overdue { border-top-color: #d52b1e; }

        .custom-scroll::-webkit-scrollbar { width: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        .loader { border: 3px solid #f3f3f3; border-top: 3px solid white; border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes slideDown { from { transform: translateY(-10px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-down { animation: slideDown 0.3s ease-out forwards; }
        
        .pdf-viewer-container { width: 100%; height: 75vh; border: none; }
    </style>
</head>
<body class="h-full text-gray-800">

    <div id="app" class="min-h-full flex flex-col max-w-7xl mx-auto shadow-xl">
        
        <!-- HEADER -->
        <header class="bg-[#d52b1e] text-white shadow-md sticky top-0 z-50 px-4 py-2.5">
            <div class="flex flex-col gap-2">
                <div class="min-w-0">
                    <h1 class="text-sm md:text-lg font-black tracking-tighter leading-none uppercase" data-i18n="title">CALIBRATION TFS TOOLS</h1>
                    <p class="text-[8px] md:text-xs text-red-100 font-medium leading-none opacity-80 mt-1" data-i18n="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‡πÅ‡∏ú‡∏ô‡∏ÅTFS</p>
                </div>

                <div class="flex items-center gap-1.5 pt-1.5 border-t border-white/20">
                    <!-- SEARCH -->
                    <div class="relative flex-1 max-w-[140px] sm:max-w-xs">
                        <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™..." 
                               class="w-full pl-7 pr-2 py-1.5 rounded bg-white border border-gray-200 text-gray-900 placeholder-gray-400 text-[11px] focus:ring-2 focus:ring-red-300 outline-none transition-all shadow-sm" 
                               onkeyup="filterBySearch()">
                        <svg class="absolute left-2 top-2 text-gray-400" width="12" height="12" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
                    </div>

                    <!-- HEADER BUTTONS -->
                    <div class="flex items-center gap-1 ml-auto">
                        <button onclick="openHelpModal()" class="px-2 py-1.5 bg-white/10 hover:bg-white/20 rounded text-[9px] font-bold flex items-center gap-1 transition border border-white/10">
                            <span>üìò</span> <span data-i18n="nav_manual">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠</span>
                        </button>
                        <button onclick="toggleLang()" class="px-2 py-1.5 bg-white/10 hover:bg-white/20 rounded text-[9px] font-bold transition w-8 text-center border border-white/10" id="langBtn">EN</button>
                        <button onclick="toggleAdmin()" id="adminBtn" class="p-1.5 bg-white/10 hover:bg-white/20 rounded transition relative border border-white/10 shadow-sm" title="Admin Mode">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                            <span id="adminIndicator" class="absolute top-0 right-0 w-2 h-2 bg-green-400 rounded-full border border-[#d52b1e] hidden"></span>
                        </button>
                        <button onclick="openGlobalHistory()" class="p-1.5 bg-white/10 hover:bg-white/20 rounded border border-white/10" title="History Logs">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/><path d="M3 3v5h5"/><path d="M12 7v5l4 2"/></svg>
                        </button>
                        <button onclick="openAddModal()" id="addBtn" class="hidden px-2.5 py-1.5 bg-white text-[#d52b1e] font-black text-[9px] rounded shadow hover:bg-red-50 transition uppercase tracking-tighter"><span>+</span> <span data-i18n="btn_add">ADD</span></button>
                    </div>
                </div>
            </div>
        </header>

        <!-- MAIN DASHBOARD -->
        <main class="p-3 pb-20 space-y-4">
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2.5">
                <div id="card-all" onclick="setFilter('all')" class="box-3d p-2.5 rounded shadow-sm card-active-all">
                    <p class="text-[9px] font-bold text-gray-400 uppercase tracking-wider" data-i18n="stat_total">TOTAL</p>
                    <h3 id="statTotal" class="text-xl font-black">0</h3>
                </div>
                <div id="card-normal" onclick="setFilter('normal')" class="box-3d p-2.5 border-l-4 border-emerald-500 rounded shadow-sm">
                    <p class="text-[9px] font-bold text-emerald-600/70 uppercase tracking-wider" data-i18n="stat_normal">NORMAL</p>
                    <h3 id="statNormal" class="text-xl font-black text-emerald-600">0</h3>
                </div>
                <div id="card-warning" onclick="setFilter('warning')" class="box-3d p-2.5 border-l-4 border-amber-500 rounded shadow-sm">
                    <p class="text-[9px] font-bold text-amber-600/70 uppercase tracking-wider" data-i18n="stat_soon">DUE SOON</p>
                    <h3 id="statWarning" class="text-xl font-black text-amber-500">0</h3>
                </div>
                <div id="card-overdue" onclick="setFilter('overdue')" class="box-3d p-2.5 border-l-4 border-red-500 rounded shadow-sm">
                    <p class="text-[9px] font-bold text-red-600/70 uppercase tracking-wider" data-i18n="stat_overdue">OVERDUE</p>
                    <h3 id="statOverdue" class="text-xl font-black text-red-600">0</h3>
                </div>
            </div>

            <div id="loadingState" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="loader !border-red-600 !border-t-transparent mb-3"></div>
                <p class="text-[10px]" data-i18n="loading">Connecting Database...</p>
            </div>

            <div id="equipmentList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden"></div>
        </main>
    </div>

    <!-- MODAL: DETAILED HELP / MANUAL -->
    <div id="helpModalOverlay" class="fixed inset-0 bg-black/80 z-[120] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-2xl max-h-[90vh] overflow-y-auto rounded-lg shadow-2xl border-t-8 border-blue-600 custom-scroll flex flex-col">
            <div class="p-4 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
                <div class="flex items-center gap-2 font-black text-sm uppercase tracking-tighter text-blue-800"><span>üìò</span> <span data-i18n="manual_modal_title">‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö</span></div>
                <button onclick="closeHelpModal()" class="text-gray-400 hover:text-black font-bold text-xl">&times;</button>
            </div>
            <div class="p-6 space-y-8 text-xs text-gray-600 leading-relaxed overflow-y-auto" id="manualBody">
                <!-- Translated Content Injected via JS -->
            </div>
            <div class="p-4 bg-gray-50 text-center border-t">
                <button onclick="closeHelpModal()" class="px-10 py-2.5 bg-gray-800 text-white font-bold text-xs rounded uppercase tracking-widest shadow hover:bg-black transition-all" data-i18n="btn_close">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- MODAL: LOGIN -->
    <div id="loginModal" class="fixed inset-0 bg-black/80 z-[110] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs p-6 rounded-lg text-center shadow-2xl border-t-8 border-[#d52b1e] animate-slide-down">
            <div class="text-3xl mb-2">üõ°Ô∏è</div>
            <h3 class="font-black text-sm mb-4 uppercase" data-i18n="admin_login">Admin Login</h3>
            <div class="relative mb-4">
                <input type="password" id="adminPass" class="w-full border-2 border-gray-200 p-2.5 text-center rounded-lg font-bold focus:border-[#d52b1e] outline-none" placeholder="PASSWORD">
                <button onclick="togglePassVisibility()" class="absolute right-3 top-3 text-gray-400">
                    <span id="eyeIcon">üëÅÔ∏è</span>
                </button>
            </div>
            <div class="flex gap-2">
                <button onclick="document.getElementById('loginModal').classList.add('hidden')" class="flex-1 text-gray-400 font-bold text-[10px] uppercase" data-i18n="btn_cancel">Cancel</button>
                <button onclick="checkLogin()" class="flex-1 py-2.5 bg-[#d52b1e] text-white font-bold rounded-lg text-[10px] shadow-sm" data-i18n="btn_login">LOGIN</button>
            </div>
        </div>
    </div>

    <!-- MODAL: CUSTOM ALERT -->
    <div id="notificationModal" class="fixed inset-0 bg-black/80 z-[300] hidden flex items-center justify-center p-4 backdrop-blur-md">
        <div class="bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl animate-slide-down border-t-8" id="notifBorder">
            <div class="p-6 text-center">
                <div id="notifIcon" class="text-4xl mb-3"></div>
                <h3 id="notifTitle" class="font-black text-lg text-gray-800 mb-2 uppercase">Title</h3>
                <p id="notifMessage" class="text-gray-600 text-sm mb-6 leading-relaxed">Message.</p>
                <div id="notifActions" class="flex gap-2"></div>
            </div>
        </div>
    </div>

    <!-- MODAL: PDF PREVIEW -->
    <div id="pdfPreviewModal" class="fixed inset-0 bg-black/80 z-[200] hidden flex items-center justify-center p-2 backdrop-blur-sm">
        <div class="bg-white w-full max-w-4xl h-fit rounded-lg shadow-2xl flex flex-col overflow-hidden animate-slide-down">
            <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
                <h3 class="font-black text-[11px] uppercase text-gray-600">üìÑ <span data-i18n="pdf_title">Calibration Certificate</span></h3>
                <button onclick="closePdfPreview()" class="w-8 h-8 flex items-center justify-center bg-white border border-gray-300 rounded-full text-lg font-bold hover:bg-red-50 text-red-600">&times;</button>
            </div>
            <div class="p-1 bg-gray-50 h-[75vh]">
                <iframe id="pdfFrame" class="w-full h-full border-none" src=""></iframe>
            </div>
            <div class="p-3 border-t bg-gray-50 flex justify-end">
                <button onclick="closePdfPreview()" class="px-5 py-2 bg-gray-800 text-white font-bold text-[10px] rounded uppercase tracking-widest shadow-sm" data-i18n="btn_close">‡∏õ‡∏¥‡∏î</button>
            </div>
        </div>
    </div>

    <!-- MODAL: HISTORY -->
    <div id="historyModal" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md max-h-[85vh] rounded-lg shadow-2xl flex flex-col overflow-hidden border-2 border-black">
            <div class="p-3 bg-gray-100 border-b flex justify-between items-center">
                <h3 class="font-black text-[10px] uppercase" id="historyModalTitle">History</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')" class="text-xl font-bold text-gray-400 hover:text-black">&times;</button>
            </div>
            <div id="historyContent" class="p-4 overflow-y-auto flex-1 space-y-3 bg-gray-50 custom-scroll"></div>
        </div>
    </div>

    <!-- MODAL: ADD / EDIT TOOL -->
    <div id="addModalOverlay" class="fixed inset-0 bg-black/70 z-[100] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md max-h-[90vh] overflow-y-auto border-2 border-black p-5 relative rounded-lg shadow-2xl custom-scroll">
            <div class="flex justify-between items-center mb-5 border-b pb-2">
                <h2 class="text-lg font-black uppercase text-gray-900" id="modalTitle" data-i18n="modal_title_add">ADD TOOL</h2>
                <button onclick="closeAddModal()" class="text-gray-400 hover:text-red-600 text-2xl font-bold">&times;</button>
            </div>
            <form id="addForm" onsubmit="submitData(event)" class="space-y-4 text-[10px]">
                <input type="hidden" id="rowIndex"> 
                <div>
                    <label class="block font-bold text-gray-400 mb-1 uppercase tracking-widest" data-i18n="label_photo">PHOTO</label>
                    <label class="block w-full h-32 bg-gray-50 border-2 border-dashed border-gray-200 hover:border-red-500 cursor-pointer relative flex items-center justify-center overflow-hidden transition-all rounded">
                        <img id="preview" class="absolute w-full h-full object-cover hidden">
                        <div id="uploadPlaceholder" class="text-center text-gray-300"><span class="text-xl">üì∑</span><p class="font-bold mt-1 uppercase" data-i18n="label_attach_photo">Attach Photo</p></div>
                        <input type="file" id="imgInput" accept="image/*" class="hidden" onchange="handleImage(this)">
                    </label>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="font-bold text-gray-400 block mb-1" data-i18n="label_id">ID *</label><input type="text" id="inp_id" required class="w-full border p-2 rounded font-bold focus:border-red-500 outline-none"></div>
                    <div><label class="font-bold text-gray-400 block mb-1" data-i18n="label_name">NAME *</label><input type="text" id="inp_name" required class="w-full border p-2 rounded font-bold focus:border-red-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="font-bold text-gray-400 block mb-1" data-i18n="label_last_date">LAST CAL</label><input type="date" id="inp_last" class="w-full border p-2 rounded focus:border-red-500 outline-none"></div>
                    <div><label class="font-bold text-red-400 block mb-1" data-i18n="label_next_date">NEXT DUE *</label><input type="date" id="inp_next" required class="w-full border border-red-100 p-2 rounded text-sm font-bold focus:border-red-500 outline-none"></div>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div><label class="font-bold text-gray-400 block mb-1" data-i18n="label_psi">PSI *</label><input type="text" id="inp_psi" required class="w-full border p-2 rounded focus:border-red-500 outline-none"></div>
                    <div><label class="font-bold text-gray-400 block mb-1" data-i18n="label_remarks">REMARKS</label><input type="text" id="inp_rem" class="w-full border p-2 rounded focus:border-red-500 outline-none"></div>
                </div>
                <div>
                    <label class="font-bold text-gray-400 block mb-1 uppercase" data-i18n="label_pdf">Calibration Doc (PDF)</label>
                    <label class="flex items-center w-full p-2 border border-gray-200 bg-gray-50 rounded cursor-pointer hover:bg-gray-100 transition-colors">
                        <span class="text-sm mr-2">üìÑ</span>
                        <span id="pdfName" class="text-gray-500 truncate flex-1 uppercase font-bold" data-i18n="label_choose_pdf">Choose PDF...</span>
                        <input type="file" id="pdfInput" accept="application/pdf" class="hidden" onchange="handlePdf(this)">
                    </label>
                </div>
                <div class="pt-2 flex gap-2">
                    <button type="button" onclick="confirmDeleteItem()" id="btnDelete" class="hidden px-4 py-2 bg-red-100 text-red-600 font-bold rounded hover:bg-red-200 transition" data-i18n="btn_delete">‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</button>
                    <div class="flex-1"></div>
                    <button type="button" onclick="closeAddModal()" class="px-4 py-2 text-gray-500 font-bold hover:underline uppercase" data-i18n="btn_cancel">CANCEL</button>
                    <button type="submit" id="submitBtn" class="px-8 py-2 bg-[#d52b1e] text-white font-black rounded shadow-sm hover:bg-red-700 transition uppercase" data-i18n="btn_save">SAVE</button>
                </div>
            </form>
        </div>
    </div>

    <!-- SCRIPTS -->
    <script>
        const API_URL = 'https://script.google.com/macros/s/AKfycbyk4ALh0Xpy34JBNOqD7jQZB4e04c5a7qIjx-XNm-aHBSHuz5mLIsyzZKJoNG34K64/exec';
        
        let allRecordsRaw = []; let allDataLatest = []; let currentFilter = 'all'; let isAdmin = false; let imageBase64 = null; let pdfBase64 = null; let currentLang = 'th';

        const translations = {
            th: {
                title: "CALIBRATION TFS TOOLS",
                subtitle: "‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô/‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ ‡πÅ‡∏ú‡∏ô‡∏ÅTFS",
                search_placeholder: "‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠/‡∏£‡∏´‡∏±‡∏™...",
                stat_total: "‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", stat_normal: "‡∏õ‡∏Å‡∏ï‡∏¥", stat_soon: "‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö", stat_overdue: "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î",
                loading: "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• TFS...",
                nav_manual: "‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠",
                btn_add: "‡πÄ‡∏û‡∏¥‡πà‡∏°", btn_save: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å", btn_cancel: "‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å", btn_delete: "‡∏•‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", btn_close: "‡∏õ‡∏¥‡∏î", btn_login: "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö", btn_confirm: "‡∏ï‡∏Å‡∏•‡∏á", btn_yes: "‡πÉ‡∏ä‡πà, ‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô",
                modal_title_add: "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå", modal_title_edit: "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•",
                label_photo: "‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢", label_attach_photo: "‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢",
                label_id: "‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ *", label_name: "‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠ *",
                label_last_date: "‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î", label_next_date: "‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î *",
                label_psi: "‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (PSI) *", label_remarks: "‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏",
                label_pdf: "‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö (PDF)", label_choose_pdf: "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF...",
                pdf_title: "‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Calibration", admin_login: "‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö",
                status_ready: "‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô", status_warning_msg: "‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏™‡πà‡∏á‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö", status_danger_msg: "‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î",
                days_left: "‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏µ‡∏Å", days_over: "‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î", history_btn: "‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥", view_doc_btn: "‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Calibration",
                confirm_delete: "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ô‡∏µ‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?",
                msg_success: "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß", msg_error_pass: "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!",
                manual_modal_title: "‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏ö‡∏ö",
                // DETAILED OVERVIEW THAI (V34 REFINED)
                man_sec1_title: "1. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏∞‡πÑ‡∏£? (System Overview)",
                man_sec1_body: "CALIBRATION TFS TOOLS ‡∏Ñ‡∏∑‡∏≠‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏°‡∏∏‡∏î‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå (Digital Logbook) ‡∏ó‡∏µ‡πà‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô TFS ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏£‡∏±‡∏ö‡∏£‡∏π‡πâ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ‡πÅ‡∏ö‡∏ö Real-time ‡∏ß‡∏±‡∏ï‡∏ñ‡∏∏‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå‡∏´‡∏•‡∏±‡∏Å‡∏Ñ‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡∏ï‡∏£‡∏á (Precision Assurance) ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏á‡∏≤‡∏ô‡∏ß‡∏¥‡∏®‡∏ß‡∏Å‡∏£‡∏£‡∏°‡∏ó‡∏∏‡∏Å‡∏ä‡∏¥‡πâ‡∏ô ‡πÇ‡∏î‡∏¢‡∏£‡∏∞‡∏ö‡∏ö‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡∏î‡∏π‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Certificate) ‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö PDF ‡πÑ‡∏î‡πâ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡∏ú‡πà‡∏≤‡∏ô‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏à‡∏≤‡∏Å‡∏´‡∏ô‡πâ‡∏≤‡∏á‡∏≤‡∏ô ‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà‡∏ó‡∏∏‡∏Å‡πÄ‡∏ß‡∏•‡∏≤ ‡∏ä‡πà‡∏ß‡∏¢‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡∏ï‡∏≤‡∏°‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏Ñ‡∏∏‡∏ì‡∏†‡∏≤‡∏û",
                man_sec2_title: "2. ‡∏Å‡∏≤‡∏£‡∏≠‡πà‡∏≤‡∏ô‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ (Status Colors)",
                man_s_green: "üü¢ ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (Normal): ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏õ‡∏Å‡∏ï‡∏¥ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏ß‡∏•‡∏≤‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ß‡∏±‡∏ô)",
                man_s_amber: "üü° ‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á (Due Soon): ‡πÉ‡∏Å‡∏•‡πâ‡∏ñ‡∏∂‡∏á‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏ô‡πâ‡∏≠‡∏¢‡∏Å‡∏ß‡πà‡∏≤ 30 ‡∏ß‡∏±‡∏ô) ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ú‡∏ô‡∏™‡πà‡∏á‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö",
                man_s_red: "üî¥ ‡∏™‡∏µ‡πÅ‡∏î‡∏á (Overdue): ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö **‡∏´‡πâ‡∏≤‡∏°‡∏ô‡∏≥‡πÑ‡∏õ‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î** ‡∏ï‡πâ‡∏≠‡∏á‡∏™‡πà‡∏á‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏ó‡∏µ",
                man_sec3_title: "3. ‡∏£‡∏∞‡∏ö‡∏ö‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö (Admin Guide)",
                man_admin_login: "‚Ä¢ ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö: ‡∏Å‡∏î‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πà (üõ°Ô∏è) ‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡∏Å‡∏î‡∏£‡∏π‡∏õ‡∏•‡∏π‡∏Å‡∏ï‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏î‡πâ)",
                man_admin_add: "‚Ä¢ ‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà ‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå PDF Certificate ‡πÑ‡∏î‡πâ",
                man_admin_history: "‚Ä¢ ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥: ‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏¥‡∏î‡πÑ‡∏î‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á"
            },
            en: {
                title: "CALIBRATION TFS TOOLS",
                subtitle: "TFS Department Tools Calibration Management System",
                search_placeholder: "Search Name/ID...",
                stat_total: "TOTAL", stat_normal: "NORMAL", stat_soon: "DUE SOON", stat_overdue: "OVERDUE",
                loading: "Connecting to TFS Database...",
                nav_manual: "MANUAL",
                btn_add: "ADD", btn_save: "SAVE", btn_cancel: "CANCEL", btn_delete: "DELETE", btn_close: "CLOSE", btn_login: "LOGIN", btn_confirm: "OK", btn_yes: "Yes, Confirm",
                modal_title_add: "Add Tool", modal_title_edit: "Edit Record",
                label_photo: "PHOTO", label_attach_photo: "Attach Photo",
                label_id: "Tool ID *", label_name: "Tool Name *",
                label_last_date: "Last Calibrated", label_next_date: "Next Due Date *",
                label_psi: "Person in Charge (PSI) *", label_remarks: "Remarks",
                label_pdf: "Calibration Certificate (PDF)", label_choose_pdf: "Choose PDF File...",
                pdf_title: "View Calibration Certificate", admin_login: "Admin Access",
                status_ready: "Ready to use", status_warning_msg: "Prepare for calibration", status_danger_msg: "DO NOT USE",
                days_left: "Days left", days_over: "Overdue", history_btn: "History", view_doc_btn: "View Calibration Doc",
                confirm_delete: "Confirm to delete this tool record?",
                msg_success: "Data saved successfully", msg_error_pass: "Incorrect password!",
                manual_modal_title: "System User Manual",
                // DETAILED OVERVIEW ENGLISH (V34 REFINED)
                man_sec1_title: "1. What is this system? (System Overview)",
                man_sec1_body: "CALIBRATION TFS TOOLS is a digital logbook system designed for the TFS team to monitor tool readiness in real-time. Our core objective is to ensure 'Precision Assurance' for every engineering project. The system allows staff to check calibration due dates and access digital certificates (PDF) instantly on-site via mobile devices anytime, anywhere. This reduces the risk of using expired or non-standard measuring equipment, maintaining the highest quality standards.",
                man_sec2_title: "2. Understanding Status Colors",
                man_s_green: "üü¢ Green (Normal): Ready for use (More than 30 days remaining)",
                man_s_amber: "üü° Amber (Due Soon): Expiration near (Less than 30 days), start planning calibration.",
                man_s_red: "üî¥ Red (Overdue): EXPIRED! **DO NOT USE** and send for re-calibration immediately.",
                man_sec3_title: "3. Admin Management Guide",
                man_admin_login: "‚Ä¢ Login: Use the shield icon (üõ°Ô∏è) and password (click Eye icon to reveal) to manage data.",
                man_admin_add: "‚Ä¢ Add/Edit: Register new tools with real photos and PDF certificate attachments.",
                man_admin_history: "‚Ä¢ History Logs: Admins can modify or delete historical records to maintain data integrity."
            }
        };

        window.onload = () => { fetchData(); updateUI(); };

        function updateUI() {
            const t = translations[currentLang];
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (t[key]) el.innerText = t[key];
            });
            document.getElementById('searchInput').placeholder = t.search_placeholder;
            document.getElementById('langBtn').innerText = currentLang === 'th' ? 'EN' : 'TH';
            
            const manual = document.getElementById('manualBody');
            manual.innerHTML = `
                <section>
                    <h3 class="font-bold text-blue-700 border-l-4 border-blue-700 pl-2 mb-3 uppercase text-sm">${t.man_sec1_title}</h3>
                    <p class="pl-2 text-gray-800 leading-relaxed text-[11px] sm:text-xs">${t.man_sec1_body}</p>
                </section>
                <section>
                    <h3 class="font-bold text-blue-700 border-l-4 border-blue-700 pl-2 mb-3 uppercase text-sm">${t.man_sec2_title}</h3>
                    <div class="space-y-1.5 pl-2 text-[11px] sm:text-xs">
                        <div class="p-2 bg-emerald-50 rounded border border-emerald-100 flex items-center gap-3">
                            <p>${t.man_s_green}</p>
                        </div>
                        <div class="p-2 bg-amber-50 rounded border border-amber-100 flex items-center gap-3">
                            <p>${t.man_s_amber}</p>
                        </div>
                        <div class="p-2 bg-red-50 rounded border border-red-100 flex items-center gap-3 text-red-700 font-bold">
                            <p>${t.man_s_red}</p>
                        </div>
                    </div>
                </section>
                <section class="bg-gray-50 p-4 rounded border border-gray-200">
                    <h3 class="font-bold text-red-700 mb-3 uppercase text-sm">${t.man_sec3_title}</h3>
                    <div class="space-y-2 text-[10px] sm:text-[11px] text-gray-700">
                        <p>${t.man_admin_login}</p>
                        <p>${t.man_admin_add}</p>
                        <p>${t.man_admin_history}</p>
                    </div>
                </section>
            `;
        }

        async function fetchData() {
            try {
                const res = await fetch(API_URL);
                const json = await res.json();
                if (json.status === 'error') throw new Error(json.message);
                allRecordsRaw = json || [];
                const groups = {};
                allRecordsRaw.forEach(item => { if(!groups[item.id]) groups[item.id] = []; groups[item.id].push(item); });
                allDataLatest = Object.values(groups).map(group => {
                    group.sort((a, b) => new Date(b.nextDate) - new Date(a.nextDate));
                    const latest = group[0];
                    const diff = Math.ceil((new Date(latest.nextDate) - new Date()) / (1000 * 60 * 60 * 24));
                    latest.days = diff;
                    latest.status = diff < 0 ? 'overdue' : (diff <= 30 ? 'warning' : 'normal');
                    latest.history = group;
                    return latest;
                }).sort((a, b) => { const p = { overdue: 0, warning: 1, normal: 2 }; return p[a.status] - p[b.status]; });
                updateStats(); applyFilter();
                document.getElementById('loadingState').classList.add('hidden');
                document.getElementById('equipmentList').classList.remove('hidden');
            } catch (err) { console.error(err); }
        }

        function showCustomAlert(title, message, type = 'success', onConfirm = null) {
            const modal = document.getElementById('notificationModal');
            const border = document.getElementById('notifBorder');
            const tit = document.getElementById('notifTitle');
            const msg = document.getElementById('notifMessage');
            const actions = document.getElementById('notifActions');
            const t = translations[currentLang];
            border.className = "bg-white w-full max-w-sm rounded-xl overflow-hidden shadow-2xl animate-slide-down border-t-8";
            actions.innerHTML = '';
            if(type === 'error') { border.classList.add('border-red-600'); document.getElementById('notifIcon').innerText = '‚ö†Ô∏è'; tit.className = 'font-black text-lg text-red-600 mb-2 uppercase'; }
            else if(type === 'confirm') { border.classList.add('border-amber-500'); document.getElementById('notifIcon').innerText = '‚ùì'; tit.className = 'font-black text-lg text-amber-600 mb-2 uppercase'; }
            else { border.classList.add('border-green-500'); document.getElementById('notifIcon').innerText = '‚úÖ'; tit.className = 'font-black text-lg text-green-600 mb-2 uppercase'; }
            tit.innerText = title; msg.innerText = message;
            if(type === 'confirm') {
                actions.innerHTML = `<button id="notifCancel" class="flex-1 py-2 text-gray-400 font-bold uppercase text-xs">${t.btn_cancel}</button><button id="notifOk" class="flex-1 py-2 bg-gray-800 text-white rounded font-bold uppercase text-xs">${t.btn_yes}</button>`;
                document.getElementById('notifCancel').onclick = () => modal.classList.add('hidden');
                document.getElementById('notifOk').onclick = () => { modal.classList.add('hidden'); if(onConfirm) onConfirm(); };
            } else {
                actions.innerHTML = `<button onclick="document.getElementById('notificationModal').classList.add('hidden')" class="w-full py-2 bg-gray-800 text-white rounded font-bold uppercase text-xs">${t.btn_confirm}</button>`;
            }
            modal.classList.remove('hidden');
        }

        function setFilter(type) {
            currentFilter = type;
            document.querySelectorAll('.box-3d').forEach(el => el.classList.remove('card-active-all', 'card-active-normal', 'card-active-warning', 'card-active-overdue'));
            document.getElementById(`card-${type}`).classList.add(type === 'all' ? 'card-active-all' : `card-active-${type}`);
            applyFilter();
        }

        function applyFilter() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            renderList(allDataLatest.filter(item => (currentFilter === 'all' || item.status === currentFilter) && (item.name.toLowerCase().includes(searchTerm) || item.id.toLowerCase().includes(searchTerm))));
        }

        function renderList(data) {
            const list = document.getElementById('equipmentList'); const t = translations[currentLang];
            list.innerHTML = data.length === 0 ? `<div class="col-span-full py-10 text-center text-gray-300 text-[10px] font-bold uppercase tracking-widest">No Items Found</div>` : '';
            data.forEach(item => {
                let statusColor = item.status === 'overdue' ? 'text-red-600' : (item.status === 'warning' ? 'text-amber-600' : 'text-emerald-600');
                let statusMsg = item.status === 'overdue' ? t.days_over : t.days_left;
                list.innerHTML += `<div class="box-3d flex flex-col rounded bg-white overflow-hidden tool-card border-${item.status}"><div class="h-32 w-full relative bg-white border-b border-gray-100">${item.image ? `<img src="${item.image}" class="w-full h-full object-cover">` : `<div class="w-full h-full flex items-center justify-center bg-gray-50 text-gray-300 text-[10px] font-bold">NO IMAGE</div>`}<div class="absolute top-2 right-2"><span class="px-2 py-1 text-[8px] font-black uppercase rounded bg-white/95 shadow-sm border ${statusColor} border-current">${statusMsg} ${Math.abs(item.days)} ${currentLang==='th'?'‡∏ß‡∏±‡∏ô':'Days'}</span></div></div><div class="p-3 flex-1 flex flex-col"><div class="flex justify-between items-center mb-1"><span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">#${item.id}</span><button onclick="viewSingleHistory('${item.id}')" class="text-[8px] text-gray-400 hover:text-gray-900 underline font-bold uppercase">üïí ${t.history_btn}</button></div><h3 class="font-black text-gray-800 text-xs leading-tight mb-2 truncate">${item.name}</h3><div class="mt-auto pt-2 border-t border-gray-50 text-[9px]"><div class="flex justify-between mb-2"><span class="text-gray-500 font-bold uppercase">PSI: ${item.psi || '-'}</span><span class="font-black text-gray-900 font-mono">${formatDate(item.nextDate)}</span></div><div class="flex flex-col gap-1">${item.pdf ? `<button onclick="openPdfPreview('${item.pdf}')" class="w-full py-1.5 bg-blue-50 text-blue-600 border border-blue-200 px-2 rounded flex items-center justify-center gap-1 transition-colors uppercase font-black tracking-tighter">üìÑ ${t.view_doc_btn}</button>` : ''}${isAdmin ? `<button onclick="editItem('${item.id}', ${item.rowIndex})" class="w-full py-1 bg-gray-800 text-white rounded shadow-sm font-black tracking-tighter">EDIT</button>` : ''}</div></div></div></div>`;
            });
        }

        function openPdfPreview(url) { let previewUrl = url.includes('drive.google.com') ? url.replace('/view', '/preview') : url; document.getElementById('pdfFrame').src = previewUrl; document.getElementById('pdfPreviewModal').classList.remove('hidden'); }
        function closePdfPreview() { document.getElementById('pdfFrame').src = ""; document.getElementById('pdfPreviewModal').classList.add('hidden'); }
        function toggleAdmin() { isAdmin ? (isAdmin = false, document.getElementById('adminIndicator').classList.add('hidden'), document.getElementById('addBtn').classList.add('hidden'), renderList(allDataLatest)) : document.getElementById('loginModal').classList.remove('hidden'); }
        function togglePassVisibility() { const inp = document.getElementById('adminPass'); const eye = document.getElementById('eyeIcon'); inp.type = inp.type === 'password' ? 'text' : 'password'; eye.innerText = inp.type === 'password' ? 'üëÅÔ∏è' : 'üôà'; }
        function checkLogin() { if (document.getElementById('adminPass').value === 'jiraphong2227') { isAdmin = true; document.getElementById('adminIndicator').classList.remove('hidden'); document.getElementById('addBtn').classList.remove('hidden'); document.getElementById('loginModal').classList.add('hidden'); document.getElementById('adminPass').value = ''; renderList(allDataLatest); showCustomAlert("Admin", currentLang === 'th' ? "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "Login Success"); } else { showCustomAlert("Admin", translations[currentLang].msg_error_pass, 'error'); } }
        
        function openGlobalHistory() { renderHistoryPopup(translations[currentLang].history_btn + " (Global)", [...allRecordsRaw].sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp))); }
        function viewSingleHistory(id) { renderHistoryPopup(`Tool ID: ${id}`, allDataLatest.find(d => d.id === id).history); }
        function renderHistoryPopup(title, data) {
            const t = translations[currentLang]; document.getElementById('historyModalTitle').innerText = title;
            const con = document.getElementById('historyContent'); con.innerHTML = '';
            data.forEach(h => { con.innerHTML += `<div class="bg-white p-3 rounded border border-gray-200 text-[10px] shadow-sm relative group"><div class="flex justify-between font-black text-gray-800 uppercase"><span>${formatDate(h.nextDate)}</span><span class="text-[8px] font-normal text-gray-400 italic">${formatDate(h.timestamp)}</span></div><div class="flex justify-between mt-1 items-center"><p class="text-gray-600 font-bold uppercase">ID: ${h.id} | PSI: ${h.psi || '-'}</p>${h.pdf ? `<button onclick="openPdfPreview('${h.pdf}')" class="text-blue-500 underline text-[8px] font-bold">Cert View</button>` : ''}</div>${isAdmin ? `<div class="mt-2 flex gap-2 border-t pt-2 opacity-10 sm:opacity-100 group-hover:opacity-100 transition-opacity"><button onclick="editItem('${h.id}', ${h.rowIndex})" class="bg-gray-100 px-3 py-1 rounded font-black hover:bg-gray-200">‚úèÔ∏è</button><button onclick="confirmDeleteHistory(${h.rowIndex})" class="bg-red-50 text-red-600 px-3 py-1 rounded font-black hover:bg-red-100">üóëÔ∏è</button></div>` : ''}</div>`; });
            document.getElementById('historyModal').classList.remove('hidden');
        }

        function confirmDeleteHistory(idx) { showCustomAlert("Delete", translations[currentLang].confirm_delete, 'confirm', async () => { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowIndex: idx }) }); document.getElementById('historyModal').classList.add('hidden'); fetchData(); }); }
        function confirmDeleteItem() { showCustomAlert("Delete", translations[currentLang].confirm_delete, 'confirm', async () => { await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', rowIndex: document.getElementById('rowIndex').value }) }); closeAddModal(); fetchData(); }); }

        function openAddModal() { const t = translations[currentLang]; document.getElementById('modalTitle').innerText = t.modal_title_add; document.getElementById('addForm').reset(); document.getElementById('preview').classList.add('hidden'); document.getElementById('uploadPlaceholder').classList.remove('hidden'); document.getElementById('pdfName').innerText = t.label_choose_pdf; document.getElementById('inp_id').readOnly = false; document.getElementById('btnDelete').classList.add('hidden'); document.getElementById('rowIndex').value = ""; imageBase64 = null; pdfBase64 = null; document.getElementById('addModalOverlay').classList.remove('hidden'); }
        function editItem(id, idx) { const item = allRecordsRaw.find(r => r.rowIndex == idx); const t = translations[currentLang]; document.getElementById('modalTitle').innerText = t.modal_title_edit; document.getElementById('rowIndex').value = idx; document.getElementById('inp_id').value = item.id; document.getElementById('inp_name').value = item.name; document.getElementById('inp_last').value = item.lastDate; document.getElementById('inp_next').value = item.nextDate; document.getElementById('inp_psi').value = item.psi; document.getElementById('inp_rem').value = item.remarks; if (item.image) { document.getElementById('preview').src = item.image; document.getElementById('preview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); } document.getElementById('btnDelete').classList.remove('hidden'); document.getElementById('addModalOverlay').classList.remove('hidden'); }
        async function submitData(e) { e.preventDefault(); const btn = document.getElementById('submitBtn'); btn.innerText = "SAVING..."; btn.disabled = true; const payload = { action: document.getElementById('rowIndex').value ? 'edit' : 'add', rowIndex: document.getElementById('rowIndex').value, id: document.getElementById('inp_id').value, name: document.getElementById('inp_name').value, lastDate: document.getElementById('inp_last').value, nextDate: document.getElementById('inp_next').value, psi: document.getElementById('inp_psi').value, remarks: document.getElementById('inp_rem').value, imageBase64: imageBase64, pdfBase64: pdfBase64, currentImage: document.getElementById('preview').src }; try { await fetch(API_URL, { method: 'POST', body: JSON.stringify(payload) }); closeAddModal(); fetchData(); showCustomAlert("Success", translations[currentLang].msg_success); } catch (err) { alert(err.message); } finally { btn.innerText = translations[currentLang].btn_save; btn.disabled = false; } }

        function filterBySearch() { applyFilter(); }
        function formatDate(d) { if(!d) return "-"; const date = new Date(d); return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`; }
        function updateStats() { document.getElementById('statTotal').innerText = allDataLatest.length; document.getElementById('statNormal').innerText = allDataLatest.filter(d => d.status === 'normal').length; document.getElementById('statWarning').innerText = allDataLatest.filter(d => d.status === 'warning').length; document.getElementById('statOverdue').innerText = allDataLatest.filter(d => d.status === 'overdue').length; }
        function closeAddModal() { document.getElementById('addModalOverlay').classList.add('hidden'); }
        function openHelpModal() { document.getElementById('helpModalOverlay').classList.remove('hidden'); }
        function closeHelpModal() { document.getElementById('helpModalOverlay').classList.add('hidden'); }
        function handleImage(i) { fileToBase64(i, (b) => { imageBase64 = b; document.getElementById('preview').src = b; document.getElementById('preview').classList.remove('hidden'); document.getElementById('uploadPlaceholder').classList.add('hidden'); }); }
        function handlePdf(i) { if(i.files[0].size > 5*1024*1024) return showCustomAlert("Error", "FILE > 5MB", 'error'); document.getElementById('pdfName').innerText = i.files[0].name; fileToBase64(i, (b) => pdfBase64 = b); }
        function fileToBase64(inp, cb) { const fr = new FileReader(); fr.onload = (e) => cb(e.target.result); fr.readAsDataURL(inp.files[0]); }
        function toggleLang() { currentLang = currentLang === 'th' ? 'en' : 'th'; updateUI(); applyFilter(); }
    </script>
</body>
</html>

