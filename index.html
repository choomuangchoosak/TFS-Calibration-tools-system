<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CALIBRATION TFS TOOLS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Kanit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Kanit', sans-serif; }
        :root { --brand-red: #D32F2F; --brand-dark: #B71C1C; }

        body { background-color: #f3f4f6; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Theme Classes */
        .bg-tfs-red { background-color: var(--brand-red); }
        .text-tfs-red { color: var(--brand-red); }
        .border-tfs-red { border-color: var(--brand-red); }
        
        .btn-primary {
            background-color: var(--brand-red); color: white;
            transition: all 0.2s; box-shadow: 0 4px 6px -1px rgba(211, 47, 47, 0.4);
        }
        .btn-primary:hover { background-color: var(--brand-dark); transform: translateY(-1px); }
        .btn-primary:active { transform: translateY(0); }

        /* Card Styles */
        .tool-card {
            background: white; border-radius: 16px; overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); border: 1px solid #e5e7eb;
            transition: all 0.2s;
        }
        .tool-card:hover { transform: translateY(-3px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

        /* Status Badges */
        .status-badge { padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
        .status-normal { background-color: #ecfdf5; color: #047857; border: 1px solid #a7f3d0; }
        .status-warning { background-color: #fffbeb; color: #b45309; border: 1px solid #fde68a; }
        .status-overdue { background-color: #fef2f2; color: #b91c1c; border: 1px solid #fecaca; }

        /* Animations */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
        
        .modal-enter { animation: modalIn 0.2s ease-out forwards; }
        @keyframes modalIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="h-full text-gray-800">

    <div id="app" class="min-h-full flex flex-col max-w-lg mx-auto bg-gray-50 min-h-screen relative shadow-2xl">
        
        <!-- HEADER (Style Image 3) -->
        <header class="bg-tfs-red text-white px-5 py-4 sticky top-0 z-40 shadow-md">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-2xl font-bold tracking-tight">TFS TOOLS</h1>
                    <p class="text-xs text-red-100 opacity-90">‡∏£‡∏∞‡∏ö‡∏ö‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</p>
                </div>
                <div class="flex gap-3">
                    <button onclick="openManual()" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                    </button>
                    <button onclick="toggleAdmin()" id="adminBtn" class="p-2 rounded-full bg-white/20 hover:bg-white/30 transition relative">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
                        <span id="adminIndicator" class="absolute top-0 right-0 w-2.5 h-2.5 bg-green-400 rounded-full border border-red-600 hidden"></span>
                    </button>
                </div>
            </div>
            
            <!-- Stats Bar -->
            <div class="flex mt-4 gap-2 text-center">
                <div class="flex-1 bg-white/10 rounded-lg p-2 backdrop-blur-sm">
                    <p class="text-[10px] opacity-75">‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</p>
                    <p class="text-lg font-bold" id="statTotal">-</p>
                </div>
                <div class="flex-1 bg-green-500/20 rounded-lg p-2 backdrop-blur-sm border border-green-400/30">
                    <p class="text-[10px] text-green-100">‡∏õ‡∏Å‡∏ï‡∏¥</p>
                    <p class="text-lg font-bold text-green-100" id="statNormal">-</p>
                </div>
                <div class="flex-1 bg-red-500/20 rounded-lg p-2 backdrop-blur-sm border border-red-400/30">
                    <p class="text-[10px] text-red-100">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</p>
                    <p class="text-lg font-bold text-red-100" id="statAlert">-</p>
                </div>
            </div>
        </header>

        <!-- SEARCH & FILTER -->
        <div class="px-4 pt-4 pb-2 sticky top-[130px] z-30 bg-gray-50/95 backdrop-blur">
            <div class="relative">
                <input type="text" id="searchInput" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠ ‡∏´‡∏£‡∏∑‡∏≠ ‡∏£‡∏´‡∏±‡∏™..." class="w-full pl-10 pr-4 py-3 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-red-500 text-sm bg-white" onkeyup="filterData()">
                <svg class="absolute left-3 top-3.5 text-gray-400" width="18" height="18" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
            <!-- Admin Add Button -->
            <button onclick="openAddModal()" id="addBtn" class="hidden w-full mt-3 btn-primary py-3 rounded-xl font-bold text-sm flex items-center justify-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà
            </button>
        </div>

        <!-- CONTENT LIST -->
        <main class="flex-1 px-4 pb-24 space-y-4" id="equipmentList">
            <!-- Loading -->
            <div id="loadingState" class="flex flex-col items-center justify-center py-20 text-gray-400">
                <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-red-600 mb-3"></div>
                <p class="text-sm">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...</p>
            </div>
        </main>

    </div>

    <!-- MODALS -->

    <!-- 1. LOGIN MODAL -->
    <div id="loginModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-xs rounded-2xl p-6 shadow-2xl modal-enter text-center">
            <div class="w-12 h-12 bg-red-100 text-red-600 rounded-full flex items-center justify-center mx-auto mb-4 text-2xl">üîí</div>
            <h3 class="text-lg font-bold mb-1">Admin Login</h3>
            <p class="text-xs text-gray-500 mb-4">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
            <input type="password" id="adminPass" class="w-full border border-gray-300 rounded-lg p-2 text-center mb-4 focus:ring-2 focus:ring-red-500 outline-none" placeholder="Password">
            <div class="flex gap-2">
                <button onclick="closeModal('loginModal')" class="flex-1 py-2 text-gray-500 text-sm font-bold">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="checkLogin()" class="flex-1 py-2 bg-tfs-red text-white rounded-lg text-sm font-bold shadow-lg">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <!-- 2. ADD/EDIT TOOL MODAL -->
    <div id="toolModal" class="fixed inset-0 bg-black/60 z-50 hidden flex items-end sm:items-center justify-center p-0 sm:p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md h-[90vh] sm:h-auto sm:max-h-[85vh] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col modal-enter relative">
            
            <!-- Modal Header -->
            <div class="px-6 py-4 border-b flex justify-between items-center bg-gray-50 rounded-t-2xl">
                <h2 class="text-xl font-bold text-gray-800" id="modalTitle">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</h2>
                <button onclick="closeModal('toolModal')" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>

            <!-- Modal Body -->
            <div class="p-6 overflow-y-auto flex-1 space-y-4">
                <form id="toolForm" onsubmit="submitData(event)">
                    <input type="hidden" name="id_ref" id="id_ref"> <!-- For Edit reference -->
                    
                    <!-- Photo -->
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-500 mb-2 uppercase">‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label>
                        <label class="block w-full h-48 bg-gray-100 border-2 border-dashed border-gray-300 rounded-xl cursor-pointer hover:border-red-400 transition relative overflow-hidden group">
                            <img id="preview" class="absolute inset-0 w-full h-full object-cover hidden">
                            <div id="uploadPlaceholder" class="flex flex-col items-center justify-center h-full text-gray-400 group-hover:text-red-400">
                                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>
                                <span class="text-xs mt-2 font-medium">‡πÅ‡∏ï‡∏∞‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏π‡∏õ (‡∏Ñ‡∏•‡∏±‡∏á‡∏†‡∏≤‡∏û/‡∏Å‡∏•‡πâ‡∏≠‡∏á)</span>
                            </div>
                            <input type="file" id="imgInput" accept="image/*" class="hidden" onchange="handleImage(this)">
                        </label>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div><label class="text-xs font-bold text-gray-500">‡∏£‡∏´‡∏±‡∏™‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (ID)</label><input type="text" name="id" id="inp_id" required class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-red-500 outline-none"></div>
                        <div><label class="text-xs font-bold text-gray-500">‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå</label><input type="text" name="name" id="inp_name" required class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-red-500 outline-none"></div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div><label class="text-xs font-bold text-gray-500">‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</label><input type="date" name="lastDate" id="inp_last" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm"></div>
                        <div><label class="text-xs font-bold text-gray-500 text-red-600">‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î *</label><input type="date" name="nextDate" id="inp_next" required class="w-full bg-white border border-red-200 p-2.5 rounded-lg text-sm font-semibold focus:ring-2 focus:ring-red-500"></div>
                    </div>

                    <div class="mt-4"><label class="text-xs font-bold text-gray-500">‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö (PSI)</label><input type="text" name="psi" id="inp_psi" required class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm"></div>
                    <div class="mt-4"><label class="text-xs font-bold text-gray-500">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</label><input type="text" name="remarks" id="inp_remarks" class="w-full bg-gray-50 border border-gray-200 p-2.5 rounded-lg text-sm"></div>

                    <!-- PDF -->
                    <div class="mt-4">
                        <label class="text-xs font-bold text-gray-500 mb-2 block">‡πÅ‡∏ô‡∏ö‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ Calibration (PDF)</label>
                        <label class="flex items-center w-full p-3 bg-blue-50 border border-blue-200 rounded-lg cursor-pointer hover:bg-blue-100 transition">
                            <span class="text-xl mr-3">üìÑ</span>
                            <span id="pdfName" class="text-xs text-blue-700 font-medium truncate">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF...</span>
                            <input type="file" id="pdfInput" accept="application/pdf" class="hidden" onchange="handlePdf(this)">
                        </label>
                    </div>
                </form>
            </div>

            <!-- Footer -->
            <div class="p-4 border-t bg-gray-50 rounded-b-2xl flex gap-3">
                <button onclick="closeModal('toolModal')" class="flex-1 py-3 bg-white border border-gray-300 text-gray-700 font-bold rounded-xl text-sm">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button onclick="document.getElementById('toolForm').dispatchEvent(new Event('submit'))" id="submitBtn" class="flex-1 py-3 bg-tfs-red text-white font-bold rounded-xl text-sm shadow-lg">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</button>
            </div>
        </div>
    </div>

    <!-- 3. PDF VIEWER MODAL -->
    <div id="pdfModal" class="fixed inset-0 bg-black/80 z-[70] hidden flex items-center justify-center p-2 backdrop-blur-sm">
        <div class="bg-white w-full h-full max-w-4xl max-h-[90vh] rounded-lg shadow-2xl flex flex-col relative">
            <div class="bg-gray-800 text-white p-3 flex justify-between items-center rounded-t-lg">
                <span class="font-bold text-sm">üìÑ Document Viewer</span>
                <button onclick="closeModal('pdfModal')" class="text-gray-400 hover:text-white text-xl font-bold">‚úï</button>
            </div>
            <div class="flex-1 bg-gray-100 relative">
                <iframe id="pdfFrame" src="" class="w-full h-full border-none"></iframe>
            </div>
        </div>
    </div>

    <!-- 4. HISTORY MODAL -->
    <div id="historyModal" class="fixed inset-0 bg-black/60 z-[65] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-md max-h-[80vh] rounded-2xl shadow-xl flex flex-col">
            <div class="p-4 border-b bg-gray-50 rounded-t-2xl flex justify-between items-center">
                <h3 class="font-bold text-lg text-gray-800">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö</h3>
                <button onclick="closeModal('historyModal')" class="text-gray-400 hover:text-red-500 text-2xl">&times;</button>
            </div>
            <div id="historyContent" class="p-4 overflow-y-auto flex-1 space-y-3">
                <!-- History Items -->
            </div>
        </div>
    </div>

    <!-- 5. UNIFIED POPUP ALERT -->
    <div id="alertPopup" class="fixed top-4 left-4 right-4 z-[80] hidden animate-fade-in">
        <div class="bg-white border-l-4 border-tfs-red shadow-2xl rounded-r-lg p-4 flex items-start gap-3 max-w-md mx-auto">
            <div class="text-2xl">‚ö†Ô∏è</div>
            <div class="flex-1">
                <h4 class="font-bold text-gray-800" id="alertTitle">‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô</h4>
                <p class="text-sm text-gray-600" id="alertMsg">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î...</p>
            </div>
            <button onclick="document.getElementById('alertPopup').classList.add('hidden')" class="text-gray-400">&times;</button>
        </div>
    </div>

    <!-- 6. USER MANUAL MODAL -->
    <div id="manualModal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg max-h-[85vh] rounded-2xl shadow-2xl overflow-hidden flex flex-col">
            <div class="bg-tfs-red p-4 flex justify-between items-center text-white">
                <h2 class="font-bold text-lg">üìò ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô</h2>
                <button onclick="closeModal('manualModal')" class="text-white/80 hover:text-white text-2xl">&times;</button>
            </div>
            <div class="p-6 overflow-y-auto text-sm text-gray-700 space-y-4">
                <div>
                    <h3 class="font-bold text-tfs-red mb-1">1. ‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á</h3>
                    <p>‡∏£‡∏∞‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏Ñ‡∏£‡∏ö‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏≠‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏°‡∏∑‡∏≠‡∏ß‡∏±‡∏î ‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏ô‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏£‡∏´‡∏±‡∏™ Admin</p>
                </div>
                <div>
                    <h3 class="font-bold text-tfs-red mb-1">2. ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏™‡∏µ</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><span class="text-green-600 font-bold">‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß:</span> ‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ > 30 ‡∏ß‡∏±‡∏ô)</li>
                        <li><span class="text-yellow-600 font-bold">‡∏™‡∏µ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á:</span> ‡πÉ‡∏Å‡∏•‡πâ‡∏Ñ‡∏£‡∏ö (‡πÄ‡∏´‡∏•‡∏∑‡∏≠ < 30 ‡∏ß‡∏±‡∏ô)</li>
                        <li><span class="text-red-600 font-bold">‡∏™‡∏µ‡πÅ‡∏î‡∏á:</span> ‡πÄ‡∏Å‡∏¥‡∏ô‡∏Å‡∏≥‡∏´‡∏ô‡∏î (‡∏ï‡πâ‡∏≠‡∏á‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏ô‡∏ó‡∏µ)</li>
                    </ul>
                </div>
                <div>
                    <h3 class="font-bold text-tfs-red mb-1">3. ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ï‡πà‡∏≤‡∏á‡πÜ</h3>
                    <ul class="list-disc pl-5 space-y-1">
                        <li><strong>üìÑ ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏µ‡∏ü‡πâ‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡πÑ‡∏ü‡∏•‡πå PDF ‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</li>
                        <li><strong>üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á</li>
                        <li><strong>üîí Admin:</strong> ‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πà‡πÅ‡∏•‡∏∞‡πÉ‡∏™‡πà‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</li>
                    </ul>
                </div>
            </div>
            <div class="p-4 bg-gray-50 text-center border-t">
                <button onclick="closeModal('manualModal')" class="px-6 py-2 bg-gray-800 text-white rounded-lg text-sm">‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á</button>
            </div>
        </div>
    </div>

    <script>
        // *** CONFIG ***
        const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVKnhJyBqOn8Pk9lfITsEVa3lrMUEC-lvu76V77luxZQa_WagUZg5uaEJrgdY9kGE0/exec';
        
        // State
        let allData = [];
        let displayData = [];
        let isAdmin = false;
        let imageBase64 = null;
        let pdfBase64 = null;

        // Init
        window.onload = () => {
            fetchData();
        };

        // --- CORE FUNCTIONS ---

        async function fetchData() {
            try {
                const res = await fetch(GOOGLE_SCRIPT_URL);
                if (!res.ok) throw new Error("Connection Failed");
                const text = await res.text();
                const json = JSON.parse(text);
                
                if (json.status === 'error') throw new Error(json.message);
                
                // Process Data (Group by ID for History)
                processData(Array.isArray(json) ? json : []);
                
            } catch (err) {
                console.error(err);
                showAlert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î", "‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: " + err.message);
                document.getElementById('loadingState').innerHTML = `<p class="text-red-500">Connection Error</p><button onclick="location.reload()" class="mt-2 text-blue-500 underline">Reload</button>`;
            }
        }

        function processData(data) {
            // Sort by Date Descending
            data.sort((a, b) => new Date(b.nextDate) - new Date(a.nextDate));
            
            // Group History: Create Map of ID -> Array of Records
            const grouped = {};
            data.forEach(item => {
                if(!grouped[item.id]) grouped[item.id] = [];
                grouped[item.id].push(item);
            });

            // Flatten to get only latest items for Main View
            displayData = Object.values(grouped).map(group => {
                const latest = group[0]; // First one is latest due to sort
                // Calculate Status
                const diff = Math.ceil((new Date(latest.nextDate) - new Date()) / (1000 * 60 * 60 * 24));
                latest.days = diff;
                latest.status = diff < 0 ? 'overdue' : (diff <= 30 ? 'warning' : 'normal');
                latest.history = group; // Attach history array
                return latest;
            });

            // Sort Main View (Overdue First)
            displayData.sort((a, b) => {
                const priority = { overdue: 0, warning: 1, normal: 2 };
                return priority[a.status] - priority[b.status];
            });

            allData = displayData; // Store original
            renderList(displayData);
            updateStats();
            checkAlerts();
        }

        function renderList(data) {
            const container = document.getElementById('equipmentList');
            container.innerHTML = '';
            document.getElementById('loadingState').classList.add('hidden');

            data.forEach(item => {
                // Determine Styles
                let statusClass = item.status === 'overdue' ? 'status-overdue' : (item.status === 'warning' ? 'status-warning' : 'status-normal');
                let statusText = item.status === 'overdue' ? `‡πÄ‡∏Å‡∏¥‡∏ô ${Math.abs(item.days)} ‡∏ß‡∏±‡∏ô` : `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${item.days} ‡∏ß‡∏±‡∏ô`;
                
                // Image
                const imgHTML = item.image ? `<img src="${item.image}" class="w-24 h-24 object-cover rounded-lg border bg-gray-100">` : `<div class="w-24 h-24 bg-gray-100 rounded-lg flex items-center justify-center text-gray-400 text-xs">No Img</div>`;

                // Actions
                const pdfBtn = item.pdf ? `<button onclick="viewPdf('${item.pdf}')" class="text-xs bg-blue-50 text-blue-600 px-2 py-1 rounded border border-blue-200 flex items-center gap-1 hover:bg-blue-100">üìÑ ‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</button>` : '';
                
                // Admin Actions (Hidden by default)
                const adminActions = `
                    <div class="admin-only ${isAdmin ? '' : 'hidden'} mt-3 pt-3 border-t border-gray-100 flex gap-2">
                        <button onclick="editTool('${item.id}')" class="flex-1 py-1.5 text-xs bg-gray-100 text-gray-700 rounded hover:bg-gray-200">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    </div>
                `;

                const card = `
                    <div class="tool-card p-4 flex gap-4 animate-fade-in relative">
                        <div class="shrink-0 flex flex-col gap-2">
                            ${imgHTML}
                            <button onclick="viewHistory('${item.id}')" class="text-[10px] bg-gray-100 text-gray-600 py-1 rounded border hover:bg-gray-200 flex items-center justify-center gap-1">
                                üïí ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                            </button>
                        </div>
                        <div class="flex-1 min-w-0">
                            <div class="flex justify-between items-start mb-1">
                                <span class="text-xs font-bold text-gray-400 uppercase tracking-wide">${item.id}</span>
                                <span class="status-badge ${statusClass}">${statusText}</span>
                            </div>
                            <h3 class="font-bold text-gray-900 text-lg leading-tight truncate mb-2">${item.name}</h3>
                            
                            <div class="space-y-1 text-sm text-gray-600">
                                <div class="flex items-center gap-2"><span class="text-gray-400 w-4">üë§</span> ${item.owner}</div>
                                <div class="flex items-center gap-2"><span class="text-gray-400 w-4">üìÖ</span> <span class="font-mono font-bold text-gray-800">${formatDate(item.nextDate)}</span></div>
                            </div>

                            <div class="mt-3 flex flex-wrap gap-2">
                                ${pdfBtn}
                            </div>
                            ${adminActions}
                        </div>
                    </div>
                `;
                container.innerHTML += card;
            });
        }

        // --- ADMIN SYSTEM ---
        function toggleAdmin() {
            if (isAdmin) {
                // Logout
                isAdmin = false;
                document.getElementById('adminIndicator').classList.add('hidden');
                document.getElementById('addBtn').classList.add('hidden');
                renderList(displayData);
                showAlert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö", "‡∏Ñ‡∏∏‡∏ì‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î Admin ‡πÅ‡∏•‡πâ‡∏ß");
            } else {
                // Open Login
                document.getElementById('loginModal').classList.remove('hidden');
            }
        }

        function checkLogin() {
            const pass = document.getElementById('adminPass').value;
            if (pass === 'jiraphong2227') {
                isAdmin = true;
                document.getElementById('adminIndicator').classList.remove('hidden');
                document.getElementById('addBtn').classList.remove('hidden');
                closeModal('loginModal');
                document.getElementById('adminPass').value = '';
                renderList(displayData); // Re-render to show buttons
                showAlert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏¢‡∏¥‡∏ô‡∏î‡∏µ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö Admin");
            } else {
                alert("‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!");
            }
        }

        // --- HISTORY ---
        function viewHistory(id) {
            const item = displayData.find(d => d.id === id);
            if (!item || !item.history) return;

            const container = document.getElementById('historyContent');
            container.innerHTML = '';

            item.history.forEach(h => {
                container.innerHTML += `
                    <div class="p-3 bg-gray-50 rounded-lg border border-gray-100">
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-bold text-gray-700">${formatDate(h.nextDate)}</span>
                            <span class="text-xs text-gray-400">Calibration Date</span>
                        </div>
                        <p class="text-xs text-gray-500">PSI: ${h.owner}</p>
                        ${h.remarks ? `<p class="text-xs text-gray-500 italic">"${h.remarks}"</p>` : ''}
                        ${h.pdf ? `<a href="${h.pdf.replace('/view', '/preview')}" target="_blank" class="text-[10px] text-blue-500 underline mt-1 block">‡∏î‡∏π‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£</a>` : ''}
                    </div>
                `;
            });
            document.getElementById('historyModal').classList.remove('hidden');
        }

        // --- ACTIONS ---
        function openAddModal() {
            document.getElementById('modalTitle').innerText = "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏°‡πà";
            document.getElementById('toolForm').reset();
            document.getElementById('preview').classList.add('hidden');
            document.getElementById('uploadPlaceholder').classList.remove('hidden');
            document.getElementById('pdfName').innerText = "‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå PDF...";
            document.getElementById('inp_id').readOnly = false;
            imageBase64 = null; pdfBase64 = null;
            document.getElementById('toolModal').classList.remove('hidden');
        }

        function editTool(id) {
            const item = displayData.find(d => d.id === id);
            if(!item) return;

            // Pre-fill form
            document.getElementById('modalTitle').innerText = "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå";
            document.getElementById('inp_id').value = item.id;
            document.getElementById('inp_id').readOnly = true; // ID cannot change
            document.getElementById('inp_name').value = item.name;
            document.getElementById('inp_last').value = item.lastDate ? new Date(item.lastDate).toISOString().split('T')[0] : '';
            document.getElementById('inp_next').value = item.nextDate ? new Date(item.nextDate).toISOString().split('T')[0] : '';
            document.getElementById('inp_psi').value = item.owner;
            document.getElementById('inp_remarks').value = item.remarks || '';
            
            // Show Modal
            document.getElementById('toolModal').classList.remove('hidden');
        }

        function viewPdf(url) {
            // Convert /view to /preview for embedding
            const previewUrl = url.replace('/view', '/preview');
            document.getElementById('pdfFrame').src = previewUrl;
            document.getElementById('pdfModal').classList.remove('hidden');
        }

        // --- SUBMIT ---
        function submitData(e) {
            e.preventDefault();
            const btn = document.getElementById('submitBtn');
            const originalText = btn.innerText;
            btn.innerText = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...";
            btn.disabled = true;

            const formData = new FormData(e.target);
            const payload = {
                id: formData.get('id'), name: formData.get('name'), lastDate: formData.get('lastDate'),
                nextDate: formData.get('nextDate'), psi: formData.get('psi'), remarks: formData.get('remarks'),
                imageBase64: imageBase64, pdfBase64: pdfBase64
            };

            fetch(GOOGLE_SCRIPT_URL, { method: 'POST', body: JSON.stringify(payload) })
            .then(res => res.json())
            .then(data => {
                if(data.status === 'success') {
                    showAlert("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢");
                    closeModal('toolModal');
                    fetchData(); // Reload
                } else throw new Error(data.message);
            })
            .catch(err => { alert("Error: " + err.message); })
            .finally(() => { btn.innerText = originalText; btn.disabled = false; });
        }

        // --- HELPERS & UTILS ---
        function closeModal(id) { document.getElementById(id).classList.add('hidden'); }
        function openManual() { document.getElementById('manualModal').classList.remove('hidden'); }
        
        function showAlert(title, msg) {
            document.getElementById('alertTitle').innerText = title;
            document.getElementById('alertMsg').innerText = msg;
            const popup = document.getElementById('alertPopup');
            popup.classList.remove('hidden');
            setTimeout(() => popup.classList.add('hidden'), 4000);
        }

        function checkAlerts() {
            const count = displayData.filter(d => d.status === 'overdue' || d.status === 'warning').length;
            if (count > 0) showAlert("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", `‡∏°‡∏µ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö`);
        }

        function updateStats() {
            document.getElementById('statTotal').innerText = displayData.length;
            document.getElementById('statNormal').innerText = displayData.filter(d => d.status === 'normal').length;
            document.getElementById('statAlert').innerText = displayData.filter(d => d.status !== 'normal').length;
        }

        function filterData() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const filtered = displayData.filter(d => d.name.toLowerCase().includes(term) || d.id.toLowerCase().includes(term));
            renderList(filtered);
        }

        function handleImage(input) {
            fileToBase64(input, (base64) => {
                imageBase64 = base64;
                document.getElementById('preview').src = base64;
                document.getElementById('preview').classList.remove('hidden');
                document.getElementById('uploadPlaceholder').classList.add('hidden');
            }, true);
        }

        function handlePdf(input) {
            if(input.files[0].size > 5*1024*1024) { alert("File too large > 5MB"); input.value=""; return; }
            document.getElementById('pdfName').innerText = input.files[0].name;
            fileToBase64(input, (base64) => { pdfBase64 = base64; }, false);
        }

        function fileToBase64(input, callback, compress) {
            if (!input.files || !input.files[0]) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                if (compress) {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const cvs = document.createElement('canvas');
                        const scale = 800 / img.width;
                        cvs.width = 800; cvs.height = img.height * scale;
                        cvs.getContext('2d').drawImage(img, 0, 0, cvs.width, cvs.height);
                        callback(cvs.toDataURL('image/jpeg', 0.6));
                    };
                } else {
                    callback(e.target.result);
                }
            };
            reader.readAsDataURL(input.files[0]);
        }

        function formatDate(d) {
            if(!d) return "-";
            const date = new Date(d);
            return `${date.getDate()}/${date.getMonth()+1}/${date.getFullYear()}`;
        }
    </script>
</body>
</html>


